# Eloquent JavaScript

**3rd edition (2018)** 

Written by Marijn Haverbeke.

## 介绍

> 我们认为我们正在为我们自己的目的创建系统。我们相信，我们是在用自己的形象去创造它......但是计算机跟我们一点也不像。它是我们自身一部分的微小投射：逻辑、顺序、规则、明辨是非的能力。
>
> —— Ellen Ullman, Close to the Machine: Technophilia and its Discontents

这是一本关于指示计算机（译者说：也就是如何给计算机下指令，然后让它执行。）的书籍。计算机和今天的螺丝刀一样平常，但是计算机非常复杂，让它们去做你想让它们做的事情，并不是那么容易的。

如果任务很普通，比如给你看你的邮件或者让它表现得像个计算器，那你可以打开相应的应用然后就能工作了。可是对于比较独特或者开放式的任务（译者说：更加多样、人性化的功能），那就没有对应的应用了。

于是，这就是**编程**登场的时候了，编程就是编写程序，构建一个程序的动作。程序是什么呢？它是一组明确的指示，这些指示告诉计算机需要做什么。计算机非常愚笨、而又像个书呆子，因此从根本上来说，编程是非常枯燥乏味的。

幸运的是，如果你能克服这个困难，你会很享受思考的严谨性，它会让你感到这很值得。它会让你在几秒钟之内完成手动很久的事情，就是这样一个途径，却让你的计算机成为工具做以前办不到的事。与此同时，它提供了一个不错的锻炼抽象思维能力的练习。

大部分的变成通过编程语言来完成。一个编程语言就是一个人工构建出来指示计算机的语言。有趣的是，我们发现与计算机沟通的最有效的方式来源于我们人类自己如何沟通。就像人类的语言一样，计算机语言允许单词和短语 ( words and phrases ) 以一种全新的方式组合在一起，从而让表达新的概念成为可能。

一方面是基于语言的界面，比如80、90年代的 BASIC 和 DOS 提示符，是与计算机交互的主要方式。它们在很大程度上已经被视觉界面所取代，因为视觉界面更加易于学习，虽然提供了更少的自由度。然而，计算机语言仍然就在那里，你要找的话随时都能找到。JavaScript就是一个，它被内置在每一个现代的web浏览器中，因此它能够在几乎所有的设备上使用。

这本书将会试着让你充分地熟悉这门语言，这样你就能用它做有用和有趣的事。

### 关于编程这件事

除了解释 JavaScript ，我也会介绍有关编程的基本概念。事实上，编程很难。虽然基本规则简单明了，但是建立在这些规则上的程序往往会变得非常复杂，以至于难以介绍它们自己的规则和复杂性。你建造了自己的迷宫，却有可能迷失其中。

有时候阅读这本书会感到非常沮丧。如果你是一个编程新手，将会有许多新的内容需要消化。大部分的内容需要你自己做额外的链接和补充。

这取决于你是否需要做出必要的努力。当你挑战这本书的时候，不要对自己的能力妄下定论。你很不错，你只需要坚持下去。( You are fine—you just need to keep at it.  )  休息一下，重新阅读一些材料，确保自己能够读懂示例和练习。学习是一件艰苦的事情，但是你学到的所有东西都是你自己的，它将让你以后的学习更加容易。

> 当行动无益时，那就收集信息；当信息无益时，那就睡觉。
>
> —— Ursula K. Le Guin, The Left Hand of Darkness

一个程序包含很多东西，它是程序员输入的一串文本，它是一种直接让计算机去做它该做的事的力量，它是在计算机内存中的数据。试着将程序比作我们在现实生活中熟悉的某个物件（对象），往往会失败。表面上比较合适的一个类比是应该是一台机器，许多独立的部分被执行，然后让整个机器嗡嗡作响。我们必须考虑这些部分如何互相联系，然后对整体的运作做出贡献。

计算机是一台物理的机器，充当这些非物质机器（指程序）的主机。计算机本身只能愚笨地做非常直接的事情。而它们如此有用的原因是，它们能够以难以置信的速度完成这些事情。一个程序可以巧妙地组合大量简单的动作来实现非常复杂的事情。

程序是思想的构建。它不要钱，也没有重量，可以在我们打字的手底下轻松地生长着。但一不留神，它的大小和复杂度就会失去控制，连创造它的人都搞不懂它了。让程序受控制是编程的主要问题。当一个程序运作起来，它就会变得很漂亮。编程的艺术就是控制复杂度的能力。一个程序复杂程度控制得越好，这个程序就越美。

一些程序员认为，在他们的程序中只使用一小部分易于理解的技术是最好的管理这种复杂性的方法。他们指定了严格的规则（最佳实践）来规定程序应该具有的形式，然后小心地呆在它们的安全区域。

这不仅无聊，而且无效。新的问题经常需要新的解决方案。编程这个领域还很年轻，它仍然在不断地发展，它的变化范围很大，足以容纳各种不同的方法。在程序设计中经常会遇到很多可怕的错误，你应该继续写下去以便自己能够理解它们为什么错。好的程序看起来是像什么样子的呢？我们会在实践中认识，而不是在一堆规则的列表中学来。

### 为什么程序很重要

在计算机诞生之初，还没有编程语言。编程看起来是这样的：

```
00110001 00000000 00000000
00110001 00000001 00000001
00110011 00000001 00000010
01010001 00001011 00000010
00100010 00000010 00001000
01000011 00000001 00000000
01000001 00000001 00000001
00010000 00000010 00000000
01100010 00000000 00000000
```

这是一个从1加到10的程序：1+ 2 + ... + 10，最后结果是 55。它能够在一个简单的机器上运行，为了对早期的计算机进行编程，必须将大量的开关设置在正确的位置，或者在纸板条上打孔，然后将其反馈给计算机。你也许可以想象这个过程是多么繁琐且容易出错。即便是写简单的程序也需要更多的智慧和纪律。复杂的呢，几乎不可想象。

当然，手动输入这些位（1 和 0）的神秘模式确实给了程序员一种深刻的好像自己就是魔法师一样的感觉，这在工作满意度方面是有价值的。

之前的程序每一行都包含一条单独的指令。它可以用英语这样写下来：

1. 将数字0存储在内存位置0
2. 将数字1存储在内存位置1
3. 将内存位置1的值存储在内存位置2中
4. 从内存位置2的值中减去数字11
5. 如果内存位置2中的值是0，继续执行指令9
6. 将内存位置1的值添加到内存位置0中
7. 在内存位置1的值上加上数字1
8. 继续指令3
9. 输出内存位置0的值

尽管这已经比之前的更加易读，但仍然很模糊。使用名称而非数字作为指令和内存地址的话，就会有所帮助。

```
 Set “total” to 0.
 Set “count” to 1.
[loop]
 Set “compare” to “count”.
 Subtract 11 from “compare”.
 If “compare” is zero, continue at [end].
 Add “count” to “total”.
 Add 1 to “count”.
 Continue at [loop].
[end]
 Output “total”.
```

你能看出这段程序是如何运作的么？头两行给出了两个内存位置保存初始值，total 用于建立计算结果，count 用于跟踪当前正在查看的数字。使用 compare 的那些行可能是最奇怪的行。程序想要查看 count 是否等于11来决定是否停止运行。因为我们的假设机器相当原始，所以它只能测试数字是否为零，并据此做出决定。因此，它使用标记了 compare 的内存位置计算 count -11 的值，并根据该值做出决定。接下来两行，程序判断在 count 不是11时，就将 count 的值添加到结果中，然后每一次都将 count 加 1。

同样的程序在 JavaScript 中是这样写的：

```javascript
let total = 0, count = 1;
while (count <= 10) {
  total += count;
  count += 1;
}
console.log(total);
// → 55
```

这个版本给了我们更多的改进。最重要的是，不再需要指定我们想要程序来回跳转的方式了。这个 ```while``` 结构处理了那个问题。只要给定的条件成立，它就会继续执行下面的块（ 用大括号括起来的部分 ）。条件是 count <= 10 ，它表示：count 小于或等于 10 。我们不再需要创建一个临时的值然后跟 0 去比较了。编程语言的部分力量在于它们可以为我们处理无趣的细节。

在程序的最后，也就是 ```while``` 结构执行完毕，后面的 ```console.log``` 操作符被用于写出结果。

最后，如果我们碰巧有这两个方便省事的操作符 ```range``` 和 ```sum``` 可以用，能够创建一个由数字组成的特定范围的集合，然后计算这个数字集合里的总和。

```javascript
console.log(sum(range(1, 10)));
// → 55
```

这个故事的寓意是，相同的程序可以通过长和短、不可读和可读的方式表达出来。第一个版本的程序非常模糊难懂，然而后一个版本的程序几乎就是英语：`log` the `sum` of the `range` of numbers from 1 to 10.（ 写出数字范围 1-10 的总和 ）（ 我们将会在之后的章节看到如何定义像 ```sum``` 和 ```range``` ）

一个像样的程序语言能够帮助程序员将精力花在有用的事情上，它是可以忽略没用的细节的。提供方便的构造块（比如```while```和```console.log```），允许你去定义你自己的构造块（比如```sum```和```range```），让那些块结构容易编写、组合。

### JavaScript 是什么？

JavaScript 是在1995年引入的，它是一种在 Netscape Navigator 浏览器中向网页添加程序的方法。自此以后，这门语言被所有其他的主要图形web浏览器所采用。它使现代Web应用程序成为可能，你可以直接与它交互而不需要重新加载页面。JavaScript 还用于更传统的网站中，来提供各种形式的交互。

重点要说的是，JavaScript 和 Java 几乎没有任何关系。相似的名字出于营销的考虑而不是良好的判断。当 JavaScript 被引入时，Java 语言正在大量销售并且获得普及。有人就认为，尝试着借助它的成功顺势爬上去是一个非常好的主意。然而现在我们却被这个名字所困扰。

在Netscape之外被采用之后，一份标准文档被编写出来描述 JavaScript 语言的工作方式，这样声称支持 JavaScript 的各种软件实际上都在谈论同一语言。在 Ecma 国际组织做了标准化之后，这份标准文档就被称为 **ECMAScript standard** 。实际上，ECMAScript 和 JavaScript 可以互换，它们是同一门语言的不同叫法，指的是同样一个东西。

有些人会说一些关于 JavaScript 的不太好的事情。但这些都是真的。在我第一次被要求用 JS 去写一些程序的时候，我很快就鄙视它了。它几乎可以接受我输入的任何东西，但解释它的方式与我的想法完全不同。这在很大程度上是因为我当时并不知道自己在做什么，但这里有一个真正的问题：JavaScript 在允许的范围内是非常荒谬的。这背后的设计思想是让使用JS编程的初学者更加容易上手这门语言。事实上，它使在程序中查找问题变得更加困难了，因为系统并不会为你指出到底哪里错了。

当然，它的优点就是更加灵活。它为许多在更严格的语言中不可能实现的技术留出了空间，正如你所见，它可以用来克服 JavaScript 的一些缺点。在正确地学习 JS 并使用了一段时间之后，我发现我超爱它。

已经有好几个版本的JS了，ECMAScript version 3 是JavaScript走向统治地位时得到广泛支持的版本，时间大概在 2000 年到 2010 年之间。在这期间，雄心勃勃的第4版也在进行中，它计划对JS做出一些根本性的改进和扩展。以一种激进的方式去改变一个生活化的、被广泛使用的语言注定失败，第4版的计划在 2008 年被放弃。这导致了第5版就没有那么雄心勃勃，只是做了一些没有什么争议的改进，这一版在 2009 年发布。第6版在2015年发布，这才有一个比较大的更新，其中包括了一些在第4版中提到的想法。在那以后，每年我们都会有一些新的、微小的更新。

语言在发展迭代的同时也意味着浏览器要紧跟步伐，如果你正在用一个老版本的浏览器，那么它可能没法支持每一个新特性。语言的设计者很小心，不去做任何可能破坏现有程序的改变，这样新的浏览器就能跑老的程序。这本书中，我将会使用 2017 版本的 JavaScript。

Web浏览器不是JS唯一运行的平台。一些数据库，比如 MongoDB 和 CouchDB 就使用JS来作为它们的脚本和查询语言。几个用于桌面和服务器编程的平台，尤其是 Node.js 项目（第 20 章的主题），提供了一种在浏览器外部进行JavaScript编程的环境。

### 代码，以及如何处理代码

Code 是组成程序的文本。本书大多数章节包含大量的代码。我相信阅读代码、写代码是学习编程必不可少的部分。试着不要光看例子，而是上点心仔细阅读，理解它们。一开始可能会比较缓慢还很困惑，但是我向你保证，你很快就能掌握它的窍门。练习也是一样的，只有在你实际写出一个可行的解决方案时，才能真正理解它们的意思。

我建议你在一个实际的JS解释器中尝试你的练习答案。这样，你立刻就能得到反馈，知道程序是否有效。另外，我还希望你能够举一反三，尝试超越练习的范围。

当你在你的浏览器中阅读本书时，你能通过鼠标点击它们然后编辑或是运行所有的例子。

如果你想要在别的地方运行本书的程序，一些地方就需要注意了。许多例子是独立的，它应该可以在任何 JS 环境中运行。但之后一些章节的代码需要写在特定的环境中（ 浏览器或者Node.js ）才能运行。另外，许多章节都定义了更大的程序，并且其中出现的代码段彼此依赖或者取决于外部文件。[sandbox](https://eloquentjavascript.net/code) 提供了所有脚本和数据文件，你可以在那里选择对应的章节运行代码。

### 本书概述

这本书大致包括三部分。前 12 章讨论JS语言。之后的 7 章讲web浏览器和利用JS编程的方式。最后 2 章讲 Node.js ，它是JS运行的另一个环境。

纵观全书，有五个项目章节，它们描述了更大的示例程序让你体验更真实的编程。按照出场顺序，我们会做：一个送货机器人（[delivery robot](https://eloquentjavascript.net/07_robot.html)），一个编程语言（ [programming language](https://eloquentjavascript.net/12_language.html)），一个平台游戏（[platform game](https://eloquentjavascript.net/16_game.html)），一个像素绘图程序（[pixel paint program](https://eloquentjavascript.net/19_paint.html)），以及一个动态网页（[dynamic website](https://eloquentjavascript.net/21_skillsharing.html)）。

本书的语言部分是开头四章，介绍了JavaScript语言的基本结构。包括控制结构（[control structures](https://eloquentjavascript.net/02_program_structure.html) 例如之前遇到的 while 关键字。），函数（写你自己的 building blocks  [functions](https://eloquentjavascript.net/03_functions.html) ），以及数据结构（[data structures](https://eloquentjavascript.net/04_data.html)）。在这之后，你就可以写一些简单的程序了。下一步，第 [5](https://eloquentjavascript.net/05_higher_order.html) 章和第 [6](https://eloquentjavascript.net/06_object.html) 章介绍使用函数和对象的技术去写更多抽象的代码，并且让它们处于控制之中。

在第一个项目章节（[first project chapter](https://eloquentjavascript.net/07_robot.html)）结束后，语言部分将会继续讨论：错误处理和bug修复（[error handling and bug fixing](https://eloquentjavascript.net/08_error.html)），正则表达式（一种处理文本的重要工具 [regular expressions](https://eloquentjavascript.net/09_regexp.html)），模块化（另一种对抗复杂性的方法 [modularity](https://eloquentjavascript.net/10_modules.html)），以及异步编程（处理需要时间的事件 [asynchronous programming](https://eloquentjavascript.net/11_async.html)）。第二个项目章节（[second project chapter](https://eloquentjavascript.net/12_language.html)）会总结本书的第一个部分。

第二部分是第 [13](https://eloquentjavascript.net/13_browser.html) 章到第 [19](https://eloquentjavascript.net/19_paint.html) 章，描述 JavaScript 可以访问浏览器的工具。你将会学到在屏幕上展示东西（Chapters [14](https://eloquentjavascript.net/14_dom.html) and [17](https://eloquentjavascript.net/17_canvas.html)），回应用户输入（[Chapter 15](https://eloquentjavascript.net/15_event.html)），以及网络通信（[Chapter 18](https://eloquentjavascript.net/18_http.html)）。这一部分同样也有两个项目章节。

最后， [Chapter 20](https://eloquentjavascript.net/20_node.html) 描述 Node.js ，[Chapter 21](https://eloquentjavascript.net/21_skillsharing.html) 构建一个小网站。

### 排版约定 （Typographic conventions）

在这本书中，用等宽字体（monospaced）书写的文本将代表程序的元素，有时候它们是完整的代码片段，有时候是指附近项目的一部分。程序（之前也已经看到了一些程序）会像下面这样编写的：

```javascript
function factorial(n) {
  if (n == 0) {
    return 1;
  } else {
    return factorial(n - 1) * n;
  }
}
```

有时，为了输出一个程序产生的结果，所期望得到的结果将会写在两个斜线和一支箭的后面。

```javascript
console.log(factorial(8));
// → 40320
```

祝你好运！

**2021.4.12 Translated by Knight**